<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Workout Session</title>
    <style>
      body {
        background: #111;
        color: #fff;
        font-family: Arial, sans-serif;
        padding: 1rem;
      }

      /* Cards / Sections */
      .card,
      .session-detail,
      .workout-detail,
      .log-card {
        background: #000;
        padding: 1.5rem;
        border-radius: 16px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
        border: 2px solid #ffd700;
      }

      h2 {
        margin-top: 0;
        font-size: 1.5rem;
        color: #ffd700;
      }

      label {
        display: block;
        margin: 0.5rem 0 0.3rem;
        font-weight: bold;
        color: #fff;
      }

      input,
      textarea {
        width: 100%;
        padding: 0.5rem;
        border-radius: 10px;
        border: none;
        margin-bottom: 0.5rem;
        background: #111;
        color: #fff;
        font-size: 0.95rem;
      }

      button {
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 10px;
        color: #111;
        cursor: pointer;
        margin: 0.3rem 0.3rem 0.3rem 0;
        font-weight: bold;
        font-size: 0.9rem;
        transition: 0.2s all;
      }

      /* Buttons */
      button.add-set {
        background: #ffd700;
      }
      button.add-set:hover {
        background: #fff;
      }

      button.remove-set {
        background: #fff;
        color: #111;
      }
      button.remove-set:hover {
        background: #ffd700;
      }

      button.finish {
        background: #ffd700;
      }
      button.finish:hover {
        background: #fff;
      }

      button.title-action {
        background: #ffd700;
        color: #111;
      }
      button.title-action:hover {
        background: #fff;
      }

      /* Progress Bar */
      .progress {
        height: 8px;
        border-radius: 8px;
        background: #333;
        margin-bottom: 1rem;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        width: 0%;
        background: #ffd700;
        transition: width 0.4s ease;
      }

      /* Log Section */
      .exercise {
        margin-bottom: 1rem;
        border-bottom: 1px solid #333;
        padding-bottom: 1rem;
      }
      .set-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-bottom: 0.3rem;
      }
      .set-row input {
        flex: 1;
      }
      .set-row button {
        flex: none;
      }

      .log-total {
        font-size: 1rem;
        margin: 0.5rem 0;
        color: #ffd700;
        font-weight: bold;
      }

      .log-list {
        list-style: none;
        padding-left: 0;
        margin: 0.5rem 0 1rem;
      }
      .log-list li {
        padding: 0.3rem 0;
        border-bottom: 1px solid #333;
        font-size: 0.95rem;
      }

      .suggestion-box {
        background: #111;
        padding: 0.8rem;
        border-radius: 12px;
        margin-top: 0.5rem;
        font-size: 0.95rem;
        color: #ffd700;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      /* Workout Title Row */
      .workout-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      .title-actions button {
        margin-left: 0.5rem;
      }

      /* Summary Card */
      #summaryCard p {
        margin: 0.5rem 0;
        color: #fff;
      }
      #summaryCard ul {
        list-style-type: disc;
        margin-left: 1.5rem;
        color: #ffd700;
      }
    </style>
  </head>
  <body>
    <div class="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="session-detail">
      <h2 id="workout-title">Workout Name</h2>
      <p>
        üìÖ <span id="workout-day"></span> | üïï <span id="workout-time"></span>
      </p>
      <p>üìç Elev8 Athletics</p>
      <p><strong>Coach:</strong> Lewis Potts</p>
    </div>

    <div class="workout-detail">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.5rem;
        "
      >
        <h2>Today's Workout</h2>
        <div>
          <button class="title-action" id="toggleWorkoutBtn">
            Show Workout
          </button>
          <button class="title-action" id="copyWorkoutBtn">Copy</button>
        </div>
      </div>
      <div id="workoutTextWrapper" style="display: none">
        <div id="workoutText"></div>
      </div>
    </div>

    <div class="card log-card" id="logCard" style="display: none">
      <h2>Log Your Workout</h2>
      <div id="logContainer"></div>
      <div class="log-total">
        Total Weight: <span id="totalWeight">0</span> kg
      </div>
      <ul class="log-list" id="logList"></ul>
      <div class="suggestion-box">
        üí° Adjust weights for next session if desired.
      </div>
      <button class="finish" id="finishWorkoutBtn">Finish Workout</button>
    </div>

    <div class="card" id="summaryCard" style="display: none">
      <h2>Smart Performance Summary</h2>
      <div class="summary" id="summary"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const workout = JSON.parse(
          sessionStorage.getItem("selectedWorkout") || "{}"
        );

        // Fill header info
        document.getElementById("workout-title").textContent =
          workout.name || "No Workout Selected";
        document.getElementById("workout-day").textContent = workout.day || "";
        document.getElementById("workout-time").textContent =
          workout.time || "";

        const logCard = document.getElementById("logCard");
        const logContainer = document.getElementById("logContainer");
        const totalWeightEl = document.getElementById("totalWeight");
        const logList = document.getElementById("logList");

        const todaysWorkout = workout.details
          ? workout.details
              .split("\n")
              .map((l) => l.trim())
              .filter((l) => l)
          : ["No exercises found ‚Äî add some in the admin page!"];

        let currentExerciseIndex = 0;

        // Toggle workout display
        document.getElementById("toggleWorkoutBtn").onclick = () => {
          const w = document.getElementById("workoutTextWrapper");
          const visible = w.style.display === "block";
          w.style.display = visible ? "none" : "block";
          logCard.style.display = visible ? "none" : "block";
          document.getElementById("toggleWorkoutBtn").textContent = visible
            ? "Show Workout"
            : "Hide Workout";

          if (!visible) {
            logContainer.innerHTML = "";
            currentExerciseIndex = 0;
            showNextExercise();
          }
        };

        // Copy workout
        document.getElementById("copyWorkoutBtn").onclick = () => {
          const revealed = Array.from(
            logContainer.querySelectorAll("label")
          ).map((l) => l.textContent);
          if (revealed.length === 0) return alert("No exercises revealed yet!");
          navigator.clipboard
            .writeText(revealed.join("\n"))
            .then(() => alert("Workout copied!"));
        };

        // Show one exercise at a time
        function showNextExercise() {
          if (currentExerciseIndex >= todaysWorkout.length) return;

          const exercise = todaysWorkout[currentExerciseIndex];
          const exDiv = document.createElement("div");
          exDiv.className = "exercise";

          const label = document.createElement("label");
          label.textContent = exercise;
          exDiv.appendChild(label);

          const setsInput = document.createElement("input");
          setsInput.placeholder = "Sets";
          setsInput.type = "number";

          const repsInput = document.createElement("input");
          repsInput.placeholder = "Reps";
          repsInput.type = "number";

          const weightInput = document.createElement("input");
          weightInput.placeholder = "Weight (kg)";
          weightInput.type = "number";

          [setsInput, repsInput, weightInput].forEach((i) =>
            i.addEventListener("input", calculateTotals)
          );

          exDiv.appendChild(setsInput);
          exDiv.appendChild(repsInput);
          exDiv.appendChild(weightInput);

          const addSetBtn = document.createElement("button");
          addSetBtn.textContent = "Add Next Exercise";
          addSetBtn.className = "add-set";
          addSetBtn.onclick = () => {
            currentExerciseIndex++;
            showNextExercise();
            addSetBtn.remove();
          };
          exDiv.appendChild(addSetBtn);

          logContainer.appendChild(exDiv);
        }

        // Calculate totals
        function calculateTotals() {
          let total = 0;
          logList.innerHTML = "";
          document.querySelectorAll(".exercise").forEach((exDiv) => {
            const sets =
              +exDiv.querySelector('input[placeholder="Sets"]').value || 0;
            const reps =
              +exDiv.querySelector('input[placeholder="Reps"]').value || 0;
            const weight =
              +exDiv.querySelector('input[placeholder="Weight (kg)"]').value ||
              0;
            const lifted = sets * reps * weight;
            total += lifted;
            if (lifted > 0) {
              const li = document.createElement("li");
              li.textContent = `${
                exDiv.querySelector("label").textContent
              }: ${sets}x${reps} @ ${weight}kg ‚Üí ${lifted}kg`;
              logList.appendChild(li);
            }
          });
          totalWeightEl.textContent = total;
          return total; // important fix
        }

        // Finish workout button
        document.getElementById("finishWorkoutBtn").onclick = () => {
          const total = calculateTotals();
          if (total === 0) {
            alert("Please log at least one set.");
            return;
          }

          const rating = prompt("Rate your workout 1-10:") || "N/A";
          const niggle = prompt("Any niggles or discomfort?") || "None";

          const workoutLog = {
            date: new Date().toLocaleDateString(),
            workoutName: workout.name || "Unnamed Workout",
            entries: [],
            total,
            rating,
            niggle,
          };

          document.querySelectorAll(".exercise").forEach((exDiv) => {
            workoutLog.entries.push({
              exercise: exDiv.querySelector("label").textContent,
              sets:
                +exDiv.querySelector('input[placeholder="Sets"]').value || 0,
              reps:
                +exDiv.querySelector('input[placeholder="Reps"]').value || 0,
              weight:
                +exDiv.querySelector('input[placeholder="Weight (kg)"]')
                  .value || 0,
            });
          });

          const history = JSON.parse(
            localStorage.getItem("workoutHistory") || "[]"
          );
          history.push(workoutLog);
          localStorage.setItem("workoutHistory", JSON.stringify(history));

          // AI feedback
          const feedback = [];
          if (workoutLog.total > 10000)
            feedback.push("üî• Massive effort! Recovery is key tonight.");
          else if (workoutLog.total < 2000)
            feedback.push("Light session ‚Äî next time let‚Äôs push a bit more.");
          else feedback.push("Solid, consistent work today üëä");

          if (workoutLog.rating <= 4)
            feedback.push("You felt drained ‚Äî plan an easier recovery day.");
          if (workoutLog.rating >= 8)
            feedback.push("Great energy! Add a small progression next time.");
          if (/shoulder|knee|back/i.test(workoutLog.niggle))
            feedback.push(
              "‚ö†Ô∏è Take care of that niggle. Prioritize mobility + lighter loading."
            );

          logCard.style.display = "none";
          document.getElementById("summary").innerHTML = `
            <p><strong>Date:</strong> ${workoutLog.date}</p>
            <p><strong>Total Volume:</strong> ${workoutLog.total} kg</p>
            <p><strong>Rating:</strong> ${workoutLog.rating}/10</p>
            <p><strong>Niggle:</strong> ${workoutLog.niggle}</p>
            <hr>
            <p><strong>AI Coach Says:</strong></p>
            ${feedback
              .map((f) => `<div class="coach-msg">üí¨ ${f}</div>`)
              .join("")}
          `;
          document.getElementById("summaryCard").style.display = "block";
          document.getElementById("progressBar").style.width = "100%";
        };
      });
    </script>
  </body>
</html>
